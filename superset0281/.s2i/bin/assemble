#!/bin/bash

echo "---> Assemble START"

# restore build artifacts
if [ "$(ls /tmp/s2i/artifacts/ 2>/dev/null)" ]; then
    mv /tmp/artifacts/* $HOME/
fi

# move the application source
chmod +x /tmp/src/*
mv /tmp/src/* $HOME/

# install application deps
yum -y install postgresql-devel	mysql-devel gcc gcc-c++ cyrus-sasl-plain cyrus-sasl-devel

# set up environment
python3 -m venv .venv
source .venv/bin/activate && \
    pip install -U pip && \
    pip install -r requirements.txt && \
    pip install -r requirements-mssql.txt && \
    rm -rf .cache

# uninstall application deps
yum -y remove postgresql-devel emysql-devel gcc gcc-c++ cyrus-sasl-plain cyrus-sasl-devel python36-devel && \
    yum -y clean all

echo "---> Assemble END"